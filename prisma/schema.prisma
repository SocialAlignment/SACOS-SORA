// Story 3.1 & 3.2: Database Schema for Multi-Tenant Sora 2 Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== Story 3.1: Authentication Models =====

model User {
  id        String   @id @default(uuid())
  clerkId   String   @unique @map("clerk_id") // Clerk user ID
  email     String   @unique
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  role      String   // admin, editor, viewer
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  campaigns Campaign[]

  @@index([clerkId])
  @@index([tenantId])
  @@map("users")
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  ownerId   String   @map("owner_id") // Clerk ID of the tenant owner
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users     User[]
  campaigns Campaign[]

  @@map("tenants")
}

// ===== Story 3.2: Campaign Analytics Models =====

model Campaign {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId      String   @map("user_id") // Creator
  user        User     @relation(fields: [userId], references: [clerkId], onDelete: Cascade)
  brandId     String   @map("brand_id")
  name        String
  description String?
  status      String   @default("active") // active, paused, completed
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  combinations TestedCombination[]

  @@index([tenantId])
  @@index([userId])
  @@index([brandId])
  @@map("campaigns")
}

model TestedCombination {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id") // Story 3.4: For RLS
  campaignId      String   @map("campaign_id")
  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  videoId         String   @unique @map("video_id") // Sora video ID
  prompt          String
  stylePreset     String?  @map("style_preset")
  aspectRatio     String?  @map("aspect_ratio")
  duration        Int?     // in seconds
  notionRecordId  String?  @unique @map("notion_record_id") // For Story 3.3 sync

  // Metrics (Story 3.3: Synced from Notion)
  organicMetrics  Json?    @map("organic_metrics") // { views, likes, shares, engagement_rate, last_updated }
  winnerStatus    Boolean  @default(false) @map("winner_status")
  analyzedAt      DateTime? @map("analyzed_at")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([campaignId])
  @@index([videoId])
  @@index([notionRecordId])
  @@map("tested_combinations")
}

// ===== Story 3.3: Notion Sync Tracking =====

model SyncFailure {
  id          String    @id @default(uuid())
  tenantId    String?   @map("tenant_id") // Story 3.4: For RLS (nullable for system-level failures)
  videoId     String    @map("video_id")
  payload     Json
  error       String
  retryCount  Int       @default(0) @map("retry_count")
  nextRetryAt DateTime? @map("next_retry_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([nextRetryAt])
  @@map("sync_failures")
}

// ===== Story 3.4: Access Logging (Optional) =====

model AccessLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tenantId  String   @map("tenant_id")
  resource  String
  action    String
  timestamp DateTime @default(now())

  @@index([userId])
  @@index([tenantId])
  @@index([timestamp])
  @@map("access_logs")
}
